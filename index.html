<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self';">
<title>Quiz TTS – Q → (3s) → A</title>
<style>
  :root{--bg:#0b0f14;--panel:#111722;--text:#e8eef6;--muted:#9fb0c7;--accent:#4da3ff;--success:#4dff88;--line:#1b2433}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans","Hiragino Kaku Gothic ProN",Meiryo,sans-serif;background:var(--bg);color:var(--text)}
  header{position:sticky;top:0;z-index:10;padding:16px 20px;background:linear-gradient(180deg,#0f1624,#0b0f14);border-bottom:1px solid var(--line)}
  header h1{margin:0;font-size:18px;letter-spacing:.3px}
  .wrap{max-width:1080px;margin:0 auto;padding:18px;display:grid;gap:14px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  label{font-size:12px;color:var(--muted)}
  input,select{background:#0c1320;color:var(--text);border:1px solid var(--line);border-radius:10px;padding:10px 12px;outline:none}
  input[type="number"]{width:110px}
  input[type="file"]{padding:6px 10px;cursor:pointer}
  input[type="file"]:hover{background:#14243a;border-color:#20314a}
  button{background:#0e1a2b;color:var(--text);border:1px solid #20314a;border-radius:12px;padding:10px 14px;cursor:pointer;transition:all 0.2s}
  button:hover{background:#14243a}
  button.primary{background:var(--accent);color:#08131f;border-color:#6ab3ff;font-weight:600}
  button.primary:hover{background:#6ab3ff}
  button.success{background:var(--success);color:#08131f;border-color:#6dff98;font-weight:600}
  .pill{font-size:12px;color:var(--muted);padding:4px 8px;border:1px solid #22314a;border-radius:999px}
  .list{display:grid;gap:8px;max-height:520px;overflow:auto;padding-right:4px}
  .item{display:grid;grid-template-columns:44px 1fr 110px;gap:8px;align-items:start;padding:8px;border-radius:10px;transition:all 0.2s}
  .item:hover{background:rgba(77,163,255,0.05)}
  .item.active{outline:2px solid var(--accent);background:rgba(77,163,255,0.1)}
  .q{font-weight:700}
  .a{color:#cfe2ff;margin-top:4px}
  .muted{color:var(--muted)}
  progress{width:100%;height:12px}
  .kbd{font-size:11px;padding:2px 6px;border:1px solid #334a6e;border-radius:6px;background:#0d1523;color:#bcd0ea}
  .error{color:#ff6b6b;font-size:13px;padding:8px;background:rgba(255,107,107,0.1);border-radius:8px;margin-top:8px}
  .success-msg{color:var(--success);font-size:13px;padding:8px;background:rgba(77,255,136,0.1);border-radius:8px;margin-top:8px}
  .divider{width:1px;height:20px;background:var(--line);margin:0 5px}
  @media (max-width:760px){
    .item{grid-template-columns:34px 1fr}
    .divider{display:none}
  }
</style>
</head>
<body>
<header><h1>Quiz TTS <span class="pill">Q → (3s) → A</span></h1></header>

<main class="wrap">
  <!-- 設定 + JSON -->
  <section class="card">
    <div class="row" style="justify-content:space-between">
      <div class="row">
    
        <div class="divider"></div>
        <input id="topImportFile" type="file" accept="application/json" title="JSONファイルをインポート">
      </div>
      <div class="row">
        <button id="clearBtn">全クリア</button>
        <button id="loadSampleBtn" class="success">サンプル読込</button>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <label>問題リピート</label><input id="repeatQ" type="number" min="1" max="50" value="1">
      <label>問題間インターバル（秒）</label><input id="gapQ" type="number" min="0" max="10" value="0.5" step="0.5">
      <label>解答まで待つ（秒）</label><input id="delayA" type="number" min="0" max="30" value="3" step="0.5">
      <label>解答後インターバル（秒）</label><input id="gapAfterA" type="number" min="0" max="10" value="0.5" step="0.5">
      <label>音量</label><input id="vol" type="number" min="0" max="1" step="0.1" value="0.8">
      <label>速度</label><input id="rate" type="number" min="0.5" max="2" step="0.1" value="1">
      <label>ピッチ</label><input id="pitch" type="number" min="0" max="2" step="0.1" value="1">
      <label>Voice</label><select id="voice"></select>
      <label>言語Hint</label>
      <select id="langHint">
        <option value="en-US" selected>en-US（英語）</option>
        <option value="en-GB">en-GB</option>
        <option value="en-AU">en-AU</option>
        <option value="ja-JP">ja-JP（日本語）</option>
      </select>
      <label>解答を画面表示</label>
      <select id="showAnswer">
        <!-- ★ 通常は隠す：ただし再生中は delayA 後に「今の問題だけ」自動表示される -->
        <option value="0" selected>隠す</option>
        <option value="1">常に表示する</option>
      </select>
    </div>
  </section>

  <!-- 再生コントロール -->
  <section class="card">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <button id="startBtn" class="primary">▶︎ 開始</button>
        <button id="pauseBtn">⏸ 一時停止/再開</button>
        <button id="stopBtn">⏹ 停止</button>
        <button id="prevBtn">⏮ 前の問題</button>
        <button id="nextBtn">⏭ 次の問題</button>
      </div>
      <div class="row">
        <span class="muted">⌨ <span class="kbd">Space</span> 再生/一時停止 <span class="kbd">←/→</span> 前/次　<span class="kbd">A</span> 解答表示切替</span>
      </div>
    </div>

    <div class="row" style="width:100%">
      <progress id="prog" value="0" max="1"></progress>
    </div>
    <div class="muted" id="status">準備完了（JSONインポート or サンプル読込）</div>
    <div id="errorMsg" class="error" style="display:none"></div>
    <div id="successMsg" class="success-msg" style="display:none"></div>
  </section>

  <!-- 問題リスト -->
  <section class="card">
    <div class="row" style="justify-content:space-between">
      <label>問題リスト（クリックでその問題から再生）</label>
      <div class="row"></div>
    </div>
    <div id="list" class="list"></div>
  </section>
</main>

<script>
'use strict';

/* ---------------------------
  サンプル（すぐ試せる）
--------------------------- */
const SAMPLE_DATA = {
  version: 1,
  items: [
    { q: "白ごはん茶碗1杯（150g）のカロリーは？", a: "約250kcal" },
    { q: "食パン6枚切り1枚のカロリーは？", a: "約160kcal" },
    { q: "クロワッサン1個のカロリーは？", a: "約220kcal" },
    { q: "うどん1玉（ゆで）のカロリーは？", a: "約270kcal" },
    { q: "そば1玉（ゆで）のカロリーは？", a: "約230kcal" },
    { q: "ラーメン1杯（醤油）のカロリーは？", a: "約600kcal" },
    { q: "チャーハン1人前のカロリーは？", a: "約700kcal" },
    { q: "カレーライス1人前のカロリーは？", a: "約800kcal" },
    { q: "ハンバーグ（デミソース）1個のカロリーは？", a: "約350kcal" },
    { q: "とんかつ1枚のカロリーは？", a: "約500kcal" },
    { q: "唐揚げ（鶏もも）3個のカロリーは？", a: "約300kcal" },
    { q: "焼き魚（サバ1切れ）のカロリーは？", a: "約250kcal" },
    { q: "焼き鮭1切れのカロリーは？", a: "約180kcal" },
    { q: "卵焼き（卵2個分）のカロリーは？", a: "約300kcal" },
    { q: "目玉焼き1個のカロリーは？", a: "約90kcal" },
    { q: "ゆで卵1個のカロリーは？", a: "約80kcal" },
    { q: "ベーコン2枚のカロリーは？", a: "約120kcal" },
    { q: "ウインナー2本のカロリーは？", a: "約160kcal" },
    { q: "ピザ1切れ（Mサイズ8等分）のカロリーは？", a: "約250kcal" },
    { q: "スパゲッティミートソース1皿のカロリーは？", a: "約650kcal" },
    { q: "カルボナーラ1皿のカロリーは？", a: "約800kcal" },
    { q: "グラタン1皿のカロリーは？", a: "約450kcal" },
    { q: "オムライス1皿のカロリーは？", a: "約700kcal" },
    { q: "親子丼1杯のカロリーは？", a: "約650kcal" },
    { q: "牛丼並盛のカロリーは？", a: "約700kcal" },
    { q: "天丼1杯のカロリーは？", a: "約800kcal" },
    { q: "エビフライ2本のカロリーは？", a: "約300kcal" },
    { q: "コロッケ1個のカロリーは？", a: "約180kcal" },
    { q: "ポテトフライMサイズのカロリーは？", a: "約400kcal" },
    { q: "シーザーサラダ1皿のカロリーは？", a: "約300kcal" },
    { q: "野菜サラダ（ドレッシングなし）のカロリーは？", a: "約50kcal" },
    { q: "マヨネーズ大さじ1のカロリーは？", a: "約100kcal" },
    { q: "バター10gのカロリーは？", a: "約75kcal" },
    { q: "チーズ（プロセス）1枚のカロリーは？", a: "約60kcal" },
    { q: "牛乳200mlのカロリーは？", a: "約130kcal" },
    { q: "ヨーグルト無糖100gのカロリーは？", a: "約60kcal" },
    { q: "プリン1個のカロリーは？", a: "約150kcal" },
    { q: "ショートケーキ1個のカロリーは？", a: "約350kcal" },
    { q: "チョコレート1枚（50g）のカロリーは？", a: "約280kcal" },
    { q: "アイスクリーム1カップのカロリーは？", a: "約250kcal" },
    { q: "ドーナツ1個のカロリーは？", a: "約300kcal" },
    { q: "たい焼き1個のカロリーは？", a: "約200kcal" },
    { q: "大福1個のカロリーは？", a: "約230kcal" },
    { q: "みたらし団子3本のカロリーは？", a: "約300kcal" },
    { q: "せんべい1枚のカロリーは？", a: "約70kcal" },
    { q: "ポテトチップス1袋（60g）のカロリーは？", a: "約330kcal" },
    { q: "ナッツミックス30gのカロリーは？", a: "約180kcal" },
    { q: "バナナ1本のカロリーは？", a: "約90kcal" },
    { q: "りんご1個のカロリーは？", a: "約140kcal" },
    { q: "みかん1個のカロリーは？", a: "約45kcal" },
    { q: "アボカド1個のカロリーは？", a: "約250kcal" },
    { q: "枝豆100gのカロリーは？", a: "約130kcal" },
    { q: "冷奴1丁（300g）のカロリーは？", a: "約180kcal" },
    { q: "納豆1パックのカロリーは？", a: "約100kcal" },
    { q: "味噌汁1杯のカロリーは？", a: "約40kcal" },
    { q: "コンビニおにぎり1個のカロリーは？", a: "約180kcal" },
    { q: "サンドイッチ（ハムチーズ）1個のカロリーは？", a: "約300kcal" },
    { q: "ホットドッグ1本のカロリーは？", a: "約280kcal" },
    { q: "ハンバーガー1個のカロリーは？", a: "約300kcal" },
    { q: "チーズバーガー1個のカロリーは？", a: "約350kcal" },
    { q: "フライドチキン1ピースのカロリーは？", a: "約250kcal" },
    { q: "焼きそば1人前のカロリーは？", a: "約600kcal" },
    { q: "お好み焼き1枚のカロリーは？", a: "約700kcal" },
    { q: "たこ焼き8個のカロリーは？", a: "約450kcal" },
    { q: "餃子6個のカロリーは？", a: "約350kcal" },
    { q: "春巻き2本のカロリーは？", a: "約300kcal" },
    { q: "中華まん1個のカロリーは？", a: "約280kcal" },
    { q: "カップラーメン1個のカロリーは？", a: "約400kcal" },
    { q: "レトルトカレー1袋のカロリーは？", a: "約200kcal" },
    { q: "ビール中ジョッキ1杯のカロリーは？", a: "約200kcal" },
    { q: "赤ワイン1杯のカロリーは？", a: "約120kcal" },
    { q: "日本酒1合のカロリーは？", a: "約180kcal" },
    { q: "コーラ500mlのカロリーは？", a: "約225kcal" },
    { q: "オレンジジュース200mlのカロリーは？", a: "約90kcal" },
    { q: "スポーツドリンク500mlのカロリーは？", a: "約125kcal" },
    { q: "カフェラテMサイズのカロリーは？", a: "約150kcal" },
    { q: "ブラックコーヒー1杯のカロリーは？", a: "約5kcal" }
  ],
  settings: {
    repeatQ: 1,
    gapQ: 0.5,
    delayA: 3,
    gapAfterA: 0.5,
    vol: 0.8,
    rate: 1,
    pitch: 1,
    voice: "",
    langHint: "ja-JP",
    showAnswer: false
  }
};

/* ---------------------------
  状態（重要：セッションID方式）
--------------------------- */
let items = [];
let idx = -1;

// 再生状態
let playing = false;
let paused = false;

// 「今の再生」は何番セッションか
let playSessionId = 0;

// タイマー
let currentTimeout = null;

// ★「今の問題の解答を、画面に出して良いか」フラグ
let revealAnswerForCurrent = false;

// ★ 一度表示された解答は「ずっと表示」する
let revealedAnswerIdxSet = new Set();

/* ---------------------------
  DOM
--------------------------- */
const clearBtn = document.getElementById('clearBtn');
const loadSampleBtn = document.getElementById('loadSampleBtn');

const startBtn = document.getElementById('startBtn');
const pauseBtn = document.getElementById('pauseBtn');
const stopBtn = document.getElementById('stopBtn');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');

const prog = document.getElementById('prog');
const status = document.getElementById('status');

const topImportFile = document.getElementById('topImportFile');

const repeatQ = document.getElementById('repeatQ');
const gapQ = document.getElementById('gapQ');
const delayA = document.getElementById('delayA');
const gapAfterA = document.getElementById('gapAfterA');

const vol = document.getElementById('vol');
const rate = document.getElementById('rate');
const pitch = document.getElementById('pitch');
const voiceSel = document.getElementById('voice');
const langHint = document.getElementById('langHint');
const showAnswerSel = document.getElementById('showAnswer');

const list = document.getElementById('list');
const errorMsg = document.getElementById('errorMsg');
const successMsg = document.getElementById('successMsg');

/* ---------------------------
  UI helpers
--------------------------- */
function showError(message) {
  errorMsg.textContent = message;
  errorMsg.style.display = 'block';
  successMsg.style.display = 'none';
  setTimeout(() => { errorMsg.style.display = 'none'; }, 6000);
}

function showSuccess(message) {
  successMsg.textContent = message;
  successMsg.style.display = 'block';
  errorMsg.style.display = 'none';
  setTimeout(() => { successMsg.style.display = 'none'; }, 4000);
}

function updateStatus(msg) {
  status.textContent = msg;
}

function updateProgress() {
  if (idx >= 0 && items.length) prog.value = (idx + 1) / items.length;
  else prog.value = 0;
}

/* ---------------------------
  セキュリティ/バリデーション
--------------------------- */
function sanitizeString(str, maxLength = 5000) {
  if (typeof str !== 'string') return '';
  return str.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, '').slice(0, maxLength);
}

function safeParseNumber(value, min, max, defaultValue) {
  const num = Number(value);
  if (isNaN(num) || num < min || num > max) return defaultValue;
  return num;
}

function generateSafeId() {
  return crypto.randomUUID ? crypto.randomUUID() :
    Date.now().toString(36) + Math.random().toString(36).substr(2);
}

/* ---------------------------
  TTS
--------------------------- */
function loadVoices() {
  const voices = speechSynthesis.getVoices();
  const hint = langHint.value;
  voiceSel.innerHTML = '';

  const filtered = voices.filter(v => v.lang.startsWith(hint.substring(0, 2)));
  const sorted = filtered.length > 0 ? filtered : voices;

  sorted.forEach(v => {
    const opt = document.createElement('option');
    opt.value = v.name;
    opt.textContent = `${v.name} (${v.lang})`;
    voiceSel.appendChild(opt);
  });
}

speechSynthesis.addEventListener('voiceschanged', loadVoices);
langHint.addEventListener('change', loadVoices);
loadVoices();

function hardStop() {
  playSessionId++;
  try { speechSynthesis.cancel(); } catch(_) {}

  if (currentTimeout) {
    clearTimeout(currentTimeout);
    currentTimeout = null;
  }

  revealAnswerForCurrent = false;
}

function sleep(ms, sessionAtStart) {
  return new Promise(resolve => {
    if (ms <= 0) return resolve();
    currentTimeout = setTimeout(() => {
      currentTimeout = null;
      resolve();
    }, ms);
  }).then(() => {});
}

function speakText(text, sessionAtStart) {
  return new Promise(resolve => {
    if (sessionAtStart !== playSessionId || !playing) return resolve();

    const t = sanitizeString(String(text || ''), 5000).trim();
    if (!t) return resolve();

    const u = new SpeechSynthesisUtterance(t);
    const voices = speechSynthesis.getVoices();
    u.voice = voices.find(v => v.name === voiceSel.value) || null;

    u.volume = safeParseNumber(vol.value, 0, 1, 0.8);
    u.rate = safeParseNumber(rate.value, 0.5, 2, 1);
    u.pitch = safeParseNumber(pitch.value, 0, 2, 1);
    u.lang = langHint.value;

    const done = () => resolve();
    u.onend = done;
    u.onerror = (e) => {
      const err = (e && e.error) ? String(e.error) : 'unknown';
      if (err !== 'canceled' && err !== 'interrupted') {
        showError('音声合成エラー: ' + err);
      }
      done();
    };

    try {
      speechSynthesis.speak(u);
    } catch (e) {
      showError('TTS開始に失敗: ' + e.message);
      resolve();
    }
  });
}

/* ---------------------------
  リスト描画
--------------------------- */
function renderList() {
  list.innerHTML = '';
  const alwaysShow = showAnswerSel.value === '1';

  items.forEach((it, i) => {
    const row = document.createElement('div');
    row.className = 'item';
    row.dataset.idx = String(i);
    if (i === idx) row.classList.add('active');

    const num = document.createElement('span');
    num.className = 'muted';
    num.textContent = `#${i + 1}`;

    const textDiv = document.createElement('div');
    const qDiv = document.createElement('div');
    qDiv.className = 'q';
    qDiv.textContent = it.q || '';
    textDiv.appendChild(qDiv);

    // ★ 常に表示 or 既に表示済み or 「再生中の現在行だけ」revealAnswerForCurrent が立ったら表示
    const canShowThisAnswer = alwaysShow || revealedAnswerIdxSet.has(i) || (playing && i === idx && revealAnswerForCurrent);
    if (canShowThisAnswer && it.a) {
      const aDiv = document.createElement('div');
      aDiv.className = 'a';
      aDiv.textContent = it.a;
      textDiv.appendChild(aDiv);
    }

    const btnDiv = document.createElement('div');
    const playBtn = document.createElement('button');
    playBtn.textContent = '▶ 再生';
    playBtn.style.fontSize = '11px';
    playBtn.dataset.idx = String(i);
    btnDiv.appendChild(playBtn);

    row.appendChild(num);
    row.appendChild(textDiv);
    row.appendChild(btnDiv);

    list.appendChild(row);
  });
}

/* ---------------------------
  再生エンジン
--------------------------- */
async function playLoop(sessionAtStart) {
  while (sessionAtStart === playSessionId && playing) {
    if (idx < 0 || idx >= items.length) {
      playing = false;
      paused = false;
      revealAnswerForCurrent = false;
      updateStatus('再生完了');
      renderList();
      updateProgress();
      return;
    }

    const it = items[idx];

    // ★ 新しい問題に入った瞬間は「今回の自動表示」フラグだけ下げる
    // （ただし、既に表示済みの解答は revealedAnswerIdxSet により表示され続ける）
    revealAnswerForCurrent = false;

    renderList();
    updateProgress();
    list.children[idx]?.scrollIntoView({behavior:'smooth', block:'center'});
    updateStatus(`再生中: #${idx + 1}/${items.length}（問題 → ${delayA.value}s → 解答）`);

    const rep = safeParseNumber(repeatQ.value, 1, 50, 1);
    const gapMs = safeParseNumber(gapQ.value, 0, 10, 0.5) * 1000;
    const delayMs = safeParseNumber(delayA.value, 0, 30, 3) * 1000;
    const afterAMs = safeParseNumber(gapAfterA.value, 0, 10, 0.5) * 1000;

    // 問題を読む
    for (let r = 0; r < rep; r++) {
      if (sessionAtStart !== playSessionId || !playing) return;
      await speakText(it.q, sessionAtStart);
      if (sessionAtStart !== playSessionId || !playing) return;
      if (r < rep - 1) await sleep(gapMs, sessionAtStart);
    }

    // 解答まで待つ
    if (sessionAtStart !== playSessionId || !playing) return;
    await sleep(delayMs, sessionAtStart);

    // ★ ここで「画面上の解答」を表示する（3秒後に出るのはココ）
    if (sessionAtStart !== playSessionId || !playing) return;
    revealAnswerForCurrent = true;
    revealedAnswerIdxSet.add(idx);
    renderList();

    // 解答を読む
    if (sessionAtStart !== playSessionId || !playing) return;
    await speakText(it.a, sessionAtStart);

    // 次の問題までの間隔
    if (sessionAtStart !== playSessionId || !playing) return;
    await sleep(afterAMs, sessionAtStart);

    idx++;
    if (idx >= items.length) {
      idx = -1;
      playing = false;
      paused = false;
      revealAnswerForCurrent = false;
      updateStatus('再生完了');
      renderList();
      updateProgress();
      return;
    }
  }
}

/* ---------------------------
  操作
--------------------------- */
clearBtn.onclick = () => {
  if (!confirm('すべてクリアしますか？')) return;
  hardStop();
  playing = false;
  paused = false;
  items = [];
  idx = -1;
  revealedAnswerIdxSet = new Set();
  renderList();
  updateProgress();
  updateStatus('クリアしました');
  showSuccess('すべてクリアしました');
};

loadSampleBtn.onclick = () => {
  loadDataFromJSON(SAMPLE_DATA);
  showSuccess('サンプルを読み込みました（解答は通常非表示／再生中はdelay後に表示）');
};

startBtn.onclick = () => {
  if (!items.length) {
    showError('問題がありません。JSONインポート or サンプル読込をしてください。');
    return;
  }

  hardStop();
  playing = false;
  paused = false;

  idx = 0;
  revealAnswerForCurrent = false;
  renderList();
  updateProgress();

  playing = true;
  paused = false;
  const sessionAtStart = playSessionId;
  playLoop(sessionAtStart);
};

pauseBtn.onclick = () => {
  if (!items.length) {
    showError('問題がありません。JSONインポート or サンプル読込をしてください。');
    return;
  }

  if (!playing && !paused) {
    if (idx < 0 || idx >= items.length) idx = 0;
    hardStop();
    playing = true;
    paused = false;
    const sessionAtStart = playSessionId;
    updateStatus(`再生中: #${idx + 1}/${items.length}`);
    playLoop(sessionAtStart);
    return;
  }

  if (paused) {
    hardStop();
    playing = true;
    paused = false;
    const sessionAtStart = playSessionId;
    updateStatus(`再生再開: #${idx + 1}/${items.length}（問題から読み直し）`);
    playLoop(sessionAtStart);
    return;
  }

  if (playing) {
    hardStop();
    playing = false;
    paused = true;
    updateStatus(`一時停止中: #${idx + 1}（再開するとこの問題から読み直し）`);
    renderList();
  }
};

stopBtn.onclick = () => {
  hardStop();
  playing = false;
  paused = false;
  idx = -1;
  renderList();
  updateProgress();
  updateStatus('停止しました');
};

prevBtn.onclick = () => {
  if (!items.length) return;
  const wasPlaying = playing;

  hardStop();
  playing = false;

  if (idx < 0) idx = 0;
  idx = Math.max(0, idx - 1);
  revealAnswerForCurrent = false;
  renderList();
  updateProgress();

  if (wasPlaying) {
    playing = true;
    paused = false;
    const sessionAtStart = playSessionId;
    playLoop(sessionAtStart);
  } else {
    paused = false;
    updateStatus(`移動: #${idx + 1}/${items.length}`);
  }
};

nextBtn.onclick = () => {
  if (!items.length) return;
  const wasPlaying = playing;

  hardStop();
  playing = false;

  if (idx < 0) idx = 0;
  idx = Math.min(items.length - 1, idx + 1);
  revealAnswerForCurrent = false;
  renderList();
  updateProgress();

  if (wasPlaying) {
    playing = true;
    paused = false;
    const sessionAtStart = playSessionId;
    playLoop(sessionAtStart);
  } else {
    paused = false;
    updateStatus(`移動: #${idx + 1}/${items.length}`);
  }
};

// リストクリックでジャンプ（再生中ならそのまま続行）
list.addEventListener('click', (e) => {
  const row = e.target.closest('.item');
  if (!row) return;

  const targetIdx = parseInt(row.dataset.idx, 10);
  if (isNaN(targetIdx) || targetIdx < 0 || targetIdx >= items.length) return;

  const wasPlaying = playing;
  hardStop();
  playing = false;
  paused = false;

  idx = targetIdx;
  revealAnswerForCurrent = false;
  renderList();
  updateProgress();

  if (wasPlaying) {
    playing = true;
    const sessionAtStart = playSessionId;
    playLoop(sessionAtStart);
  } else {
    updateStatus(`選択: #${idx + 1}/${items.length}`);
  }
});

showAnswerSel.addEventListener('change', () => renderList());

// キーボード
window.addEventListener('keydown', (e) => {
  if (['INPUT','TEXTAREA','SELECT'].includes(document.activeElement.tagName)) return;

  if (e.code === 'Space') {
    e.preventDefault();
    pauseBtn.click();
  } else if (e.key === 'ArrowRight') {
    e.preventDefault();
    nextBtn.click();
  } else if (e.key === 'ArrowLeft') {
    e.preventDefault();
    prevBtn.click();
  } else if (e.key.toLowerCase() === 'a') {
    e.preventDefault();
    showAnswerSel.value = (showAnswerSel.value === '1') ? '0' : '1';
    renderList();
  }
});

/* ---------------------------
  JSON import（安全に）
--------------------------- */
function validateImportedData(data) {
  if (typeof data !== 'object' || data === null) throw new Error('Invalid data format');
  if (!Array.isArray(data.items)) throw new Error('Invalid items format');

  const validatedItems = data.items
    .slice(0, 1000)
    .map(x => {
      if (typeof x !== 'object' || x === null) return null;
      const q = sanitizeString(String(x.q || ''), 5000).trim();
      const a = sanitizeString(String(x.a || ''), 5000).trim();
      if (!q && !a) return null;
      return { id: generateSafeId(), q, a };
    })
    .filter(Boolean);

  const s = (typeof data.settings === 'object' && data.settings !== null) ? data.settings : {};
  const validatedSettings = {
    repeatQ: safeParseNumber(s.repeatQ, 1, 50, 1),
    gapQ: safeParseNumber(s.gapQ, 0, 10, 0.5),
    delayA: safeParseNumber(s.delayA, 0, 30, 3),
    gapAfterA: safeParseNumber(s.gapAfterA, 0, 10, 0.5),
    vol: safeParseNumber(s.vol, 0, 1, 0.8),
    rate: safeParseNumber(s.rate, 0.5, 2, 1),
    pitch: safeParseNumber(s.pitch, 0, 2, 1),
    voice: sanitizeString(String(s.voice || ''), 200),
    langHint: ['en-US','en-GB','en-AU','ja-JP'].includes(s.langHint) ? s.langHint : 'en-US',
    showAnswer: Boolean(s.showAnswer)
  };

  return { items: validatedItems, settings: validatedSettings };
}

function loadDataFromJSON(data) {
  try {
    hardStop();
    playing = false;
    paused = false;

    const validated = validateImportedData(data);
    items = validated.items;
    revealedAnswerIdxSet = new Set();

    repeatQ.value = validated.settings.repeatQ;
    gapQ.value = validated.settings.gapQ;
    delayA.value = validated.settings.delayA;
    gapAfterA.value = validated.settings.gapAfterA;

    vol.value = validated.settings.vol;
    rate.value = validated.settings.rate;
    pitch.value = validated.settings.pitch;
    langHint.value = validated.settings.langHint;
    showAnswerSel.value = validated.settings.showAnswer ? '1' : '0';

    loadVoices();
    if (validated.settings.voice) voiceSel.value = validated.settings.voice;

    idx = items.length ? 0 : -1;
    revealAnswerForCurrent = false;
    renderList();
    updateProgress();
    updateStatus('JSONを読み込みました');
  } catch (e) {
    showError('データの読み込みに失敗しました: ' + e.message);
  }
}

function handleFileImport(file) {
  if (!file) return;

  if (file.size > 5 * 1024 * 1024) {
    showError('ファイルサイズが大きすぎます（最大5MB）');
    return;
  }

  const r = new FileReader();
  r.onload = () => {
    try {
      const d = JSON.parse(r.result);
      loadDataFromJSON(d);
      showSuccess('JSONファイルを読み込みました');
    } catch (e) {
      showError('JSONファイルの読み込みに失敗しました: ' + e.message);
    }
  };
  r.onerror = () => showError('ファイルの読み込みに失敗しました');
  r.readAsText(file);
}

topImportFile.onchange = () => handleFileImport(topImportFile.files?.[0]);

if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
  updateStatus('iOSはTTS初回再生にユーザー操作が必要です。サイレントスイッチに注意。');
}
</script>
</body>
</html>

