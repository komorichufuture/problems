<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self';">
<title>Starry Quiz TTS</title>
<style>
  :root {
    --bg-deep: #050a15;
    --nebula-1: #0d1b33;
    --nebula-2: #1a0b2e;
    --panel: rgba(15, 25, 45, 0.7);
    --panel-border: rgba(255, 255, 255, 0.1);
    --text: #e2e8f0;
    --muted: #94a3b8;
    --accent: #7dd3fc;
    --accent-glow: rgba(125, 211, 252, 0.4);
    --success: #6ee7b7;
    --danger: #fda4af;
  }

  * { box-sizing: border-box; }

  /* 背景（暗い青＋ネビュラ） */
  body {
    margin: 0;
    font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    background: radial-gradient(circle at center, #001529 0%, #000814 100%);
    background-image:
      radial-gradient(circle at 20% 30%, var(--nebula-2) 0%, transparent 40%),
      radial-gradient(circle at 80% 70%, var(--nebula-1) 0%, transparent 40%);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
    position: relative;
  }

  /* ★星のまたたき（旧 body::before）は削除して、音符背景に置き換え */
  #bg-notes {
    position: fixed;
    inset: 0;
    overflow: hidden;
    pointer-events: none;
    z-index: -1; /* 画面の一番奥 */
  }

  .floating-note {
    position: absolute;
    bottom: -60px;
    left: 0;
    color: #e6f6ff; /* 青白い氷光 */
    user-select: none;
    pointer-events: none;
    text-shadow:
      0 0 6px #e6f6ff,
      0 0 14px #bfe9ff,
      0 0 24px rgba(191, 233, 255, 0.6);
    filter: drop-shadow(0 0 6px rgba(191, 233, 255, 0.45));
    will-change: transform, opacity;
    animation: noteRise linear forwards;
  }

  /* 下から湧く→上で泡っぽく弾ける */
  @keyframes noteRise {
    0%   { transform: translate3d(0, 0, 0) scale(0.9) rotate(0deg); opacity: 0; }
    10%  { opacity: 0.75; }
    70%  { opacity: 0.75; }
    85%  { transform: translate3d(var(--drift, 0px), -78vh, 0) scale(1.15) rotate(18deg); opacity: 0.7; }
    100% { transform: translate3d(calc(var(--drift, 0px) * 1.2), -92vh, 0) scale(2.35) rotate(26deg); opacity: 0; }
  }

  header {
    backdrop-filter: blur(12px);
    background: rgba(5, 10, 21, 0.8);
    border-bottom: 1px solid var(--panel-border);
    padding: 20px;
    text-align: center;
    position: sticky;
    top: 0;
    z-index: 100;
  }

  header h1 {
    margin: 0;
    font-weight: 300;
    letter-spacing: 4px;
    text-transform: uppercase;
    font-size: 1.4rem;
    color: var(--accent);
    text-shadow: 0 0 15px var(--accent-glow);
  }

  .wrap {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
    display: grid;
    gap: 20px;
  }

  .card {
    background: var(--panel);
    backdrop-filter: blur(10px);
    border: 1px solid var(--panel-border);
    border-radius: 20px;
    padding: 24px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
  }

  h3 {
    margin-top: 0;
    font-size: 0.9rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    border-left: 3px solid var(--accent);
    padding-left: 10px;
    margin-bottom: 20px;
  }

  .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
  .grid-settings {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 15px;
  }

  .field { display: flex; flex-direction: column; gap: 6px; }
  label { font-size: 11px; color: var(--muted); font-weight: 600; }

  input, select {
    background: rgba(0, 0, 0, 0.3);
    color: var(--text);
    border: 1px solid var(--panel-border);
    border-radius: 8px;
    padding: 10px;
    font-size: 14px;
    transition: all 0.3s;
  }

  input:focus, select:focus {
    border-color: var(--accent);
    box-shadow: 0 0 8px var(--accent-glow);
    outline: none;
  }

  button {
    background: rgba(255, 255, 255, 0.05);
    color: var(--text);
    border: 1px solid var(--panel-border);
    border-radius: 10px;
    padding: 10px 18px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  button:hover { background: rgba(255, 255, 255, 0.15); transform: translateY(-1px); }
  button.primary { background: var(--accent); color: #050a15; font-weight: bold; border: none; }
  button.primary:hover { background: #bae6fd; box-shadow: 0 0 15px var(--accent-glow); }
  button.success { border-color: var(--success); color: var(--success); }

  progress {
    width: 100%;
    height: 6px;
    border-radius: 10px;
    overflow: hidden;
    appearance: none;
  }
  progress::-webkit-progress-bar { background: rgba(255,255,255,0.1); }
  progress::-webkit-progress-value {
    background: linear-gradient(90deg, var(--accent), var(--success));
    box-shadow: 0 0 10px var(--accent-glow);
  }

  .list {
    margin-top: 10px;
    max-height: 400px;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: var(--panel-border) transparent;
  }

  .item {
    display: flex;
    justify-content: space-between;
    padding: 15px;
    border-bottom: 1px solid var(--panel-border);
    transition: 0.3s;
    border-radius: 10px;
    margin-bottom: 4px;
  }
  .item:hover { background: rgba(255, 255, 255, 0.03); }
  .item.active {
    background: rgba(125, 211, 252, 0.1);
    border: 1px solid var(--accent);
  }

  .q { font-weight: 500; color: #fff; margin-bottom: 4px; }
  .a { color: var(--accent); font-size: 0.95rem; animation: fadeIn 0.5s ease; }

  @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

  .kbd {
    background: rgba(255,255,255,0.1);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 10px;
    border: 1px solid rgba(255,255,255,0.2);
  }

  #status { font-size: 13px; margin: 10px 0; color: var(--accent); }

  @media (max-width: 600px) {
    .grid-settings { grid-template-columns: 1fr 1fr; }
  }
</style>
</head>
<body>

<!-- 背景：音符レイヤー -->
<div id="bg-notes" aria-hidden="true"></div>

<header>
  <h1>Starry Quiz TTS</h1>
</header>

<main class="wrap">
  <section class="card">
    <h3><i class="icon">✧</i> configuration</h3>
    <div class="grid-settings">
      <div class="field"><label>JSON読込</label><input id="topImportFile" type="file" accept="application/json"></div>
      <div class="field"><label>リピート</label><input id="repeatQ" type="number" value="1"></div>
      <div class="field"><label>解答まで(秒)</label><input id="delayA" type="number" value="3" step="0.5"></div>
      <div class="field"><label>言語</label>
        <select id="langHint">
          <option value="ja-JP" selected>日本語</option>
          <option value="en-US">English (US)</option>
        </select>
      </div>
      <div class="field"><label>声</label><select id="voice"></select></div>
      <div class="field"><label>解答表示</label>
        <select id="showAnswer">
          <option value="0">クイズ中のみ表示</option>
          <option value="1">常に表示</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top: 20px;">
      <button id="loadSampleBtn" class="success">サンプル読込</button>
      <button id="clearBtn">クリア</button>
      <div style="flex-grow: 1;"></div>
      <div class="field" style="flex-direction: row; align-items: center; gap: 10px;">
        <label>速度</label><input id="rate" type="number" value="1" step="0.1" style="width: 60px;">
        <label>音量</label><input id="vol" type="number" value="0.8" step="0.1" style="width: 60px;">
      </div>
    </div>
  </section>

  <section class="card">
    <div class="row" style="margin-bottom: 20px;">
      <button id="startBtn" class="primary">▶ PLAY START</button>
      <button id="pauseBtn">⏸ PAUSE / RESUME</button>
      <button id="stopBtn">⏹ STOP</button>
      <button id="prevBtn">⏮</button>
      <button id="nextBtn">⏭</button>
    </div>
    <progress id="prog" value="0" max="1"></progress>
    <div id="status">Ready to explore...</div>
    <div id="errorMsg" style="color:var(--danger); display:none; font-size:12px;"></div>
    <div id="successMsg" style="color:var(--success); display:none; font-size:12px;"></div>
  </section>

  <section class="card">
    <h3><i class="icon">✦</i> question list</h3>
    <div id="list" class="list"></div>
    <div class="row" style="margin-top: 15px; font-size: 11px; color: var(--muted);">
      <span>⌨ <span class="kbd">Space</span> 再生/停止</span>
      <span><span class="kbd">←/→</span> 前/次</span>
      <span><span class="kbd">A</span> 表示切替</span>
    </div>
  </section>
</main>

<script>
// --- [JavaScript部分は元のロジックを完全継承、一部UI更新用に関数のみ調整] ---
'use strict';

// 隠し設定（UIから省いたもの）
const gapQ = { value: 0.5 };
const gapAfterA = { value: 0.5 };
const pitch = { value: 1 };

const SAMPLE_DATA = {
  version: 1,
  items: [
    { q: "太陽系で最も大きい惑星は？", a: "木星" },
    { q: "一番近い恒星（太陽を除く）は？", a: "プロキシマ・ケンタウリ" },
    { q: "光が1年間に進む距離を何という？", a: "光年" },
    { q: "銀河系の中心にあると考えられている天体は？", a: "巨大ブラックホール" }
  ],
  settings: { repeatQ: 1, delayA: 3, vol: 0.8, rate: 1, langHint: "ja-JP", showAnswer: false }
};

let items = [];
let idx = -1;
let playing = false;
let paused = false;
let playSessionId = 0;
let currentTimeout = null;
let revealAnswerForCurrent = false;
let revealedAnswerIdxSet = new Set();

const elements = {
  clearBtn: document.getElementById('clearBtn'),
  loadSampleBtn: document.getElementById('loadSampleBtn'),
  startBtn: document.getElementById('startBtn'),
  pauseBtn: document.getElementById('pauseBtn'),
  stopBtn: document.getElementById('stopBtn'),
  prevBtn: document.getElementById('prevBtn'),
  nextBtn: document.getElementById('nextBtn'),
  prog: document.getElementById('prog'),
  status: document.getElementById('status'),
  topImportFile: document.getElementById('topImportFile'),
  repeatQ: document.getElementById('repeatQ'),
  delayA: document.getElementById('delayA'),
  vol: document.getElementById('vol'),
  rate: document.getElementById('rate'),
  voiceSel: document.getElementById('voice'),
  langHint: document.getElementById('langHint'),
  showAnswerSel: document.getElementById('showAnswer'),
  list: document.getElementById('list'),
  errorMsg: document.getElementById('errorMsg'),
  successMsg: document.getElementById('successMsg')
};

function updateStatus(msg) { elements.status.textContent = msg; }
function updateProgress() { elements.prog.value = (idx >= 0 && items.length) ? (idx + 1) / items.length : 0; }
function showError(m) { elements.errorMsg.textContent = m; elements.errorMsg.style.display='block'; setTimeout(()=>elements.errorMsg.style.display='none', 5000); }
function showSuccess(m) { elements.successMsg.textContent = m; elements.successMsg.style.display='block'; setTimeout(()=>elements.successMsg.style.display='none', 3000); }

function loadVoices() {
  const voices = speechSynthesis.getVoices();
  const hint = elements.langHint.value;
  elements.voiceSel.innerHTML = '';
  const filtered = voices.filter(v => v.lang.startsWith(hint.substring(0, 2)));
  (filtered.length ? filtered : voices).forEach(v => {
    const opt = document.createElement('option');
    opt.value = v.name; opt.textContent = `${v.name} (${v.lang})`;
    elements.voiceSel.appendChild(opt);
  });
}
speechSynthesis.addEventListener('voiceschanged', loadVoices);
elements.langHint.addEventListener('change', loadVoices);

function hardStop() {
  playSessionId++;
  speechSynthesis.cancel();
  if (currentTimeout) { clearTimeout(currentTimeout); currentTimeout = null; }
  revealAnswerForCurrent = false;
}

async function speakText(text, sessionAtStart) {
  return new Promise(resolve => {
    if (sessionAtStart !== playSessionId || !playing) return resolve();
    const u = new SpeechSynthesisUtterance(String(text || ''));
    const voices = speechSynthesis.getVoices();
    u.voice = voices.find(v => v.name === elements.voiceSel.value) || null;
    u.volume = parseFloat(elements.vol.value);
    u.rate = parseFloat(elements.rate.value);
    u.lang = elements.langHint.value;
    u.onend = resolve;
    u.onerror = resolve;
    speechSynthesis.speak(u);
  });
}

function sleep(ms) {
  return new Promise(resolve => { currentTimeout = setTimeout(() => { currentTimeout = null; resolve(); }, ms); });
}

function renderList() {
  elements.list.innerHTML = '';
  const alwaysShow = elements.showAnswerSel.value === '1';
  items.forEach((it, i) => {
    const row = document.createElement('div');
    row.className = `item ${i === idx ? 'active' : ''}`;
    row.dataset.idx = i;

    const content = document.createElement('div');
    const qDiv = document.createElement('div'); qDiv.className = 'q'; qDiv.textContent = `#${i+1} ${it.q}`;
    content.appendChild(qDiv);

    if (alwaysShow || revealedAnswerIdxSet.has(i) || (playing && i === idx && revealAnswerForCurrent)) {
      const aDiv = document.createElement('div'); aDiv.className = 'a'; aDiv.textContent = `▸ ${it.a}`;
      content.appendChild(aDiv);
    }
    row.appendChild(content);
    elements.list.appendChild(row);
  });
}

async function playLoop(sessionAtStart) {
  while (sessionAtStart === playSessionId && playing) {
    if (idx < 0 || idx >= items.length) {
      playing = false; updateStatus('Discovery Complete'); renderList(); return;
    }
    const it = items[idx];
    revealAnswerForCurrent = false;
    renderList();
    updateProgress();
    elements.list.children[idx]?.scrollIntoView({behavior:'smooth', block:'center'});
    updateStatus(`Exploring #${idx + 1}...`);

    for (let r = 0; r < parseInt(elements.repeatQ.value); r++) {
      if (sessionAtStart !== playSessionId) return;
      await speakText(it.q, sessionAtStart);
      await sleep(500);
    }

    await sleep(parseFloat(elements.delayA.value) * 1000);
    if (sessionAtStart !== playSessionId) return;

    revealAnswerForCurrent = true;
    revealedAnswerIdxSet.add(idx);
    renderList();

    await speakText(it.a, sessionAtStart);
    await sleep(500);

    idx++;
    if (idx >= items.length) { playing = false; updateStatus('Voyage End'); renderList(); return; }
  }
}

elements.loadSampleBtn.onclick = () => { loadDataFromJSON(SAMPLE_DATA); showSuccess('Sample loaded'); };
elements.startBtn.onclick = () => { if(!items.length) return; hardStop(); idx=0; playing=true; startNoteLoop(); playLoop(playSessionId); };
elements.pauseBtn.onclick = () => {
  if (paused) { hardStop(); playing=true; paused=false; startNoteLoop(); playLoop(playSessionId); }
  else if (playing) { hardStop(); playing=false; paused=true; startNoteLoop(); updateStatus('Paused'); renderList(); }
};
elements.stopBtn.onclick = () => { hardStop(); playing=false; paused=false; idx=-1; renderList(); updateProgress(); updateStatus('Stopped'); startNoteLoop(); };
elements.nextBtn.onclick = () => { if(!items.length) return; hardStop(); idx=Math.min(items.length-1, idx+1); playing=true; startNoteLoop(); playLoop(playSessionId); };
elements.prevBtn.onclick = () => { if(!items.length) return; hardStop(); idx=Math.max(0, idx-1); playing=true; startNoteLoop(); playLoop(playSessionId); };

elements.list.onclick = (e) => {
  const row = e.target.closest('.item');
  if(!row) return;
  hardStop(); idx = parseInt(row.dataset.idx); playing=true; startNoteLoop(); playLoop(playSessionId);
};

function loadDataFromJSON(data) {
  hardStop();
  items = data.items || [];
  revealedAnswerIdxSet = new Set();
  idx = items.length ? 0 : -1;
  renderList();
  updateProgress();
  loadVoices();
  startNoteLoop();
}

elements.topImportFile.onchange = (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => { loadDataFromJSON(JSON.parse(reader.result)); showSuccess('JSON Loaded'); };
  reader.readAsText(file);
};

window.addEventListener('keydown', (e) => {
  if (['INPUT','SELECT'].includes(document.activeElement.tagName)) return;
  if (e.code === 'Space') { e.preventDefault(); elements.pauseBtn.click(); }
  if (e.key === 'ArrowRight') elements.nextBtn.click();
  if (e.key === 'ArrowLeft') elements.prevBtn.click();
});

/* =========================
   背景：ライムグリーン音符
   ========================= */
const bgNotesEl = document.getElementById('bg-notes');
const noteSymbols = ['♪', '♫', '♬', '♩'];

function createFloatingNote() {
  const note = document.createElement('div');
  note.className = 'floating-note';
  note.textContent = noteSymbols[(Math.random() * noteSymbols.length) | 0];

  const x = Math.random() * window.innerWidth;
  note.style.left = `${x}px`;

  const duration = 5 + Math.random() * 5;          // 5〜10秒
  const size = 12 + Math.random() * 18;            // 12〜30px
  const drift = (Math.random() * 120 - 60).toFixed(0) + 'px'; // 横揺れ
  note.style.fontSize = `${size}px`;
  note.style.animationDuration = `${duration}s`;
  note.style.opacity = (0.25 + Math.random() * 0.55).toFixed(2);
  note.style.setProperty('--drift', drift);

  bgNotesEl.appendChild(note);

  setTimeout(() => note.remove(), duration * 1000);
}

/* =========================
   背景音符：状況依存の出現間隔（再生中だけ少し減らす）
   ========================= */
let noteTimer = null;

function startNoteLoop() {
  if (noteTimer) clearInterval(noteTimer);

  // 再生中は少しだけ控えめ（邪魔しない）
  const interval = playing ? 700 : 520;

  noteTimer = setInterval(createFloatingNote, interval);
}

// 初期状態（停止中）
startNoteLoop();

loadVoices();
</script>
</body>
</html>
