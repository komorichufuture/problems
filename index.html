<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self';">
<title>Starry Quiz TTS</title>
<style>
  :root {
    --bg-deep: #050a15;
    --nebula-1: #0d1b33;
    --nebula-2: #1a0b2e;
    --panel: rgba(15, 25, 45, 0.75);
    --panel-border: rgba(255, 255, 255, 0.1);
    --text: #e2e8f0;
    --muted: #94a3b8;
    --accent: #7dd3fc;
    --accent-glow: rgba(125, 211, 252, 0.4);
    --success: #6ee7b7;
    --danger: #fda4af;
    --player-h: 90px;
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body {
    margin: 0;
    font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    background: radial-gradient(circle at center, #001529 0%, #000814 100%);
    background-image:
      radial-gradient(circle at 20% 30%, var(--nebula-2) 0%, transparent 40%),
      radial-gradient(circle at 80% 70%, var(--nebula-1) 0%, transparent 40%);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
    position: relative;
    padding-bottom: calc(var(--player-h) + env(safe-area-inset-bottom));
  }

  #bg-notes {
    position: fixed;
    inset: 0;
    overflow: hidden;
    pointer-events: none;
    z-index: -1;
  }

  .floating-note {
    position: absolute;
    bottom: -60px;
    left: 0;
    color: #e6f6ff;
    user-select: none;
    pointer-events: none;
    text-shadow: 0 0 6px #e6f6ff, 0 0 14px #bfe9ff, 0 0 24px rgba(191,233,255,0.6);
    filter: drop-shadow(0 0 6px rgba(191,233,255,0.45));
    will-change: transform, opacity;
    animation: noteRise linear forwards;
  }

  @keyframes noteRise {
    0%   { transform: translate3d(0,0,0) scale(0.9) rotate(0deg); opacity: 0; }
    10%  { opacity: 0.75; }
    70%  { opacity: 0.75; }
    85%  { transform: translate3d(var(--drift,0px),-78vh,0) scale(1.15) rotate(18deg); opacity: 0.7; }
    100% { transform: translate3d(calc(var(--drift,0px)*1.2),-92vh,0) scale(2.35) rotate(26deg); opacity: 0; }
  }

  /* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
  header {
    backdrop-filter: blur(12px);
    background: rgba(5,10,21,0.85);
    border-bottom: 1px solid var(--panel-border);
    padding: 14px 16px;
    text-align: center;
    position: sticky;
    top: 0;
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  header h1 {
    margin: 0;
    font-weight: 300;
    letter-spacing: 3px;
    text-transform: uppercase;
    font-size: 1.1rem;
    color: var(--accent);
    text-shadow: 0 0 15px var(--accent-glow);
  }

  /* ‚îÄ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ‚îÄ */
  .wrap {
    max-width: 700px;
    margin: 0 auto;
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .card {
    background: var(--panel);
    backdrop-filter: blur(10px);
    border: 1px solid var(--panel-border);
    border-radius: 20px;
    padding: 18px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
  }

  h3 {
    margin: 0 0 14px 0;
    font-size: 0.78rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    border-left: 3px solid var(--accent);
    padding-left: 10px;
  }

  /* ‚îÄ‚îÄ‚îÄ NOW PLAYING CARD ‚îÄ‚îÄ‚îÄ */
  #nowPlaying {
    display: none;
    text-align: center;
    padding: 24px 18px;
  }

  #nowPlaying.visible { display: block; }

  .np-number {
    font-size: 0.7rem;
    color: var(--muted);
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 8px;
  }

  .np-question {
    font-size: 1.3rem;
    font-weight: 500;
    color: #fff;
    line-height: 1.5;
    margin-bottom: 20px;
    min-height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .np-answer {
    font-size: 1.1rem;
    color: var(--accent);
    text-shadow: 0 0 10px var(--accent-glow);
    min-height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.4s;
  }

  .np-answer.hidden { opacity: 0; }

  .np-progress-bar {
    width: 100%;
    height: 4px;
    background: rgba(255,255,255,0.1);
    border-radius: 99px;
    overflow: hidden;
    margin-top: 16px;
  }

  .np-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--success));
    border-radius: 99px;
    transition: width 0.3s;
    box-shadow: 0 0 8px var(--accent-glow);
  }

  /* ‚îÄ‚îÄ‚îÄ ACCORDION SETTINGS ‚îÄ‚îÄ‚îÄ */
  .accordion-toggle {
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    user-select: none;
    padding: 0;
    margin: 0 0 0 0;
    width: 100%;
    background: none;
    border: none;
    color: var(--muted);
    font-size: 0.78rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    border-left: 3px solid var(--accent);
    padding-left: 10px;
    touch-action: manipulation;
  }

  .accordion-toggle .arrow {
    transition: transform 0.3s;
    font-size: 0.85rem;
  }

  .accordion-toggle.open .arrow { transform: rotate(180deg); }

  .accordion-body {
    display: none;
    margin-top: 14px;
  }

  .accordion-body.open { display: block; }

  /* ‚îÄ‚îÄ‚îÄ SETTINGS GRID ‚îÄ‚îÄ‚îÄ */
  .grid-settings {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 12px;
  }

  .field { display: flex; flex-direction: column; gap: 5px; }
  label { font-size: 10px; color: var(--muted); font-weight: 600; }

  input, select {
    background: rgba(0,0,0,0.35);
    color: var(--text);
    border: 1px solid var(--panel-border);
    border-radius: 10px;
    padding: 10px;
    font-size: 14px;
    transition: all 0.3s;
    width: 100%;
  }

  input:focus, select:focus, textarea:focus {
    border-color: var(--accent);
    box-shadow: 0 0 8px var(--accent-glow);
    outline: none;
  }

  textarea {
    background: rgba(0,0,0,0.35);
    color: var(--text);
    border: 1px solid var(--panel-border);
    border-radius: 10px;
    padding: 10px;
    font-size: 13px;
    font-family: inherit;
    resize: vertical;
    transition: all 0.3s;
    width: 100%;
  }

  /* ‚îÄ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ‚îÄ */
  .btn {
    background: rgba(255,255,255,0.06);
    color: var(--text);
    border: 1px solid var(--panel-border);
    border-radius: 12px;
    padding: 12px 16px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    touch-action: manipulation;
    min-height: 46px;
    font-family: inherit;
  }

  .btn:active { opacity: 0.7; transform: scale(0.97); }
  .btn.primary { background: var(--accent); color: #050a15; font-weight: 700; border: none; }
  .btn.success { border-color: var(--success); color: var(--success); }
  .btn.danger { border-color: var(--danger); color: var(--danger); }
  .btn-row { display: flex; gap: 10px; flex-wrap: wrap; }
  .btn-row .btn { flex: 1; min-width: 80px; }

  /* ‚îÄ‚îÄ‚îÄ STATUS ‚îÄ‚îÄ‚îÄ */
  #status {
    font-size: 12px;
    color: var(--accent);
    text-align: center;
    letter-spacing: 1px;
  }

  #errorMsg { color: var(--danger); font-size: 12px; display: none; text-align: center; margin-top: 6px; }
  #successMsg { color: var(--success); font-size: 12px; display: none; text-align: center; margin-top: 6px; }

  /* ‚îÄ‚îÄ‚îÄ QUESTION LIST ‚îÄ‚îÄ‚îÄ */
  .list {
    max-height: 320px;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: var(--panel-border) transparent;
    -webkit-overflow-scrolling: touch;
  }

  .item {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 14px 12px;
    border-bottom: 1px solid var(--panel-border);
    transition: 0.2s;
    border-radius: 10px;
    margin-bottom: 3px;
    cursor: pointer;
    touch-action: manipulation;
  }

  .item:active { background: rgba(125,211,252,0.08); }
  .item.active { background: rgba(125,211,252,0.1); border: 1px solid var(--accent); }

  .q { font-weight: 500; color: #fff; margin-bottom: 3px; font-size: 0.9rem; }
  .a { color: var(--accent); font-size: 0.85rem; animation: fadeIn 0.5s ease; }
  .item-num { font-size: 0.7rem; color: var(--muted); min-width: 28px; padding-top: 2px; }

  @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }

  /* ‚îÄ‚îÄ‚îÄ BOTTOM PLAYER BAR ‚îÄ‚îÄ‚îÄ */
  #playerBar {
    position: fixed;
    bottom: 0;
    left: 0; right: 0;
    height: var(--player-h);
    padding-bottom: env(safe-area-inset-bottom);
    background: rgba(5, 12, 28, 0.97);
    backdrop-filter: blur(20px);
    border-top: 1px solid var(--panel-border);
    z-index: 200;
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 8px;
    padding-top: 10px;
    padding-left: 16px;
    padding-right: 16px;
  }

  .player-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
  }

  .ctrl-btn {
    background: none;
    border: none;
    color: var(--text);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s;
    touch-action: manipulation;
    font-size: 20px;
    width: 44px;
    height: 44px;
    font-family: inherit;
  }

  .ctrl-btn:active { transform: scale(0.88); opacity: 0.7; }

  .ctrl-btn.play-main {
    background: var(--accent);
    color: #050a15;
    width: 54px;
    height: 54px;
    font-size: 22px;
    box-shadow: 0 0 18px var(--accent-glow);
  }

  .ctrl-btn.play-main:active { transform: scale(0.9); }

  .player-progress {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 10px;
    color: var(--muted);
  }

  .player-prog-track {
    flex: 1;
    height: 3px;
    background: rgba(255,255,255,0.12);
    border-radius: 99px;
    overflow: hidden;
  }

  .player-prog-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--success));
    border-radius: 99px;
    transition: width 0.4s linear;
    box-shadow: 0 0 6px var(--accent-glow);
  }

  /* ‚îÄ‚îÄ‚îÄ DESKTOP: hide bottom bar, show inline controls ‚îÄ‚îÄ‚îÄ */
  @media (min-width: 700px) {
    body { padding-bottom: 0; }
    #playerBar { display: none; }
    #desktopControls { display: flex !important; }
    .grid-settings { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); }
  }

  #desktopControls {
    display: none;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 12px;
  }

  #desktopControls .btn { min-width: 110px; }

  progress {
    width: 100%;
    height: 5px;
    border-radius: 10px;
    overflow: hidden;
    appearance: none;
    display: block;
    margin-bottom: 8px;
  }
  progress::-webkit-progress-bar { background: rgba(255,255,255,0.1); }
  progress::-webkit-progress-value {
    background: linear-gradient(90deg, var(--accent), var(--success));
    box-shadow: 0 0 10px var(--accent-glow);
  }

  .kbd {
    background: rgba(255,255,255,0.1);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 9px;
    border: 1px solid rgba(255,255,255,0.2);
  }

  .hint-row {
    display: none;
    gap: 10px;
    flex-wrap: wrap;
    font-size: 10px;
    color: var(--muted);
    margin-top: 10px;
  }

  @media (min-width: 700px) { .hint-row { display: flex; } }
</style>
</head>
<body>

<div id="bg-notes" aria-hidden="true"></div>

<header>
  <h1>‚òÖ Starry Quiz TTS</h1>
  <div id="status">Ready...</div>
</header>

<main class="wrap">

  <!-- Now Playing Card („Çπ„Éû„ÉõÊôÇ„Å´ÂâçÈù¢Ë°®Á§∫) -->
  <section class="card" id="nowPlaying">
    <div class="np-number" id="npNumber">‚Äî / ‚Äî</div>
    <div class="np-question" id="npQuestion">ÂïèÈ°å„Çí„É≠„Éº„Éâ„Åó„Å¶ÈñãÂßã„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
    <div class="np-answer hidden" id="npAnswer">‚ñ∏ ‚Äî</div>
    <div class="np-progress-bar">
      <div class="np-progress-fill" id="npFill" style="width:0%"></div>
    </div>
  </section>

  <!-- ÂÜçÁîü„Ç≥„É≥„Éà„É≠„Éº„É´ („Éá„Çπ„ÇØ„Éà„ÉÉ„ÉóÁî® + „É¢„Éê„Ç§„É´„ÅßÈùûË°®Á§∫) -->
  <section class="card">
    <div id="desktopControls">
      <button class="btn primary" id="startBtn">‚ñ∂ PLAY</button>
      <button class="btn" id="pauseBtn">‚è∏ PAUSE</button>
      <button class="btn danger" id="stopBtn">‚èπ STOP</button>
      <button class="btn" id="prevBtn">‚èÆ PREV</button>
      <button class="btn" id="nextBtn">‚è≠ NEXT</button>
    </div>
    <progress id="prog" value="0" max="1"></progress>
    <div id="errorMsg"></div>
    <div id="successMsg"></div>
  </section>

  <!-- Ë®≠ÂÆö („Ç¢„Ç≥„Éº„Éá„Ç£„Ç™„É≥) -->
  <section class="card">
    <button class="accordion-toggle" id="settingsToggle">
      <span>‚öô Ë®≠ÂÆö</span>
      <span class="arrow">‚ñº</span>
    </button>
    <div class="accordion-body" id="settingsBody">
      <div class="grid-settings">
        <div class="field"><label>JSONË™≠Ëæº</label><input id="topImportFile" type="file" accept="application/json"></div>
        <div class="field"><label>„É™„Éî„Éº„ÉàÂõûÊï∞</label><input id="repeatQ" type="number" value="1" min="1"></div>
        <div class="field"><label>Ëß£Á≠î„Åæ„Åß (Áßí)</label><input id="delayA" type="number" value="3" step="0.5"></div>
        <div class="field"><label>Ë®ÄË™û</label>
          <select id="langHint">
            <option value="ja-JP" selected>Êó•Êú¨Ë™û</option>
            <option value="en-US">English (US)</option>
          </select>
        </div>
        <div class="field"><label>Â£∞</label><select id="voice"></select></div>
        <div class="field"><label>Ëß£Á≠îË°®Á§∫</label>
          <select id="showAnswer">
            <option value="0">„ÇØ„Ç§„Ç∫‰∏≠„ÅÆ„Åø</option>
            <option value="1">Â∏∏„Å´Ë°®Á§∫</option>
          </select>
        </div>
        <div class="field"><label>ÈÄüÂ∫¶</label><input id="rate" type="number" value="1" step="0.1" min="0.5" max="3"></div>
        <div class="field"><label>Èü≥Èáè</label><input id="vol" type="number" value="0.8" step="0.1" min="0" max="1"></div>
      </div>

      <div class="field" style="margin-bottom:10px;">
        <label>Áõ¥Êé•ÂÖ•ÂäõÔºàË≥™Âïè|Á≠î„Åà„ÄÄ1Ë°å1ÂïèÔºâ</label>
        <textarea id="directInput" rows="4" placeholder="Â§™ÈôΩÁ≥ª„ÅßÊúÄ„ÇÇÂ§ß„Åç„ÅÑÊÉëÊòü„ÅØÔºü|Êú®Êòü
ÂÖâ„Åå1Âπ¥Èñì„Å´ÈÄ≤„ÇÄË∑ùÈõ¢„Çí‰Ωï„Å®„ÅÑ„ÅÜÔºü|ÂÖâÂπ¥
ÊúÄ„ÇÇËøë„ÅÑÊÅíÊòü„ÅØÔºü|„Éó„É≠„Ç≠„Ç∑„Éû„Éª„Ç±„É≥„Çø„Ç¶„É™"></textarea>
      </div>

      <div class="btn-row">
        <button class="btn primary" id="loadDirectBtn">üìã ÂÖ•Âäõ„Åã„ÇâË™≠Ëæº</button>
        <button class="btn success" id="loadSampleBtn">„Çµ„É≥„Éó„É´</button>
        <button class="btn" id="clearBtn">„ÇØ„É™„Ç¢</button>
      </div>
    </div>
  </section>

  <!-- ÂïèÈ°å„É™„Çπ„Éà -->
  <section class="card">
    <h3>‚ú¶ ÂïèÈ°å„É™„Çπ„Éà</h3>
    <div id="list" class="list"></div>
    <div class="hint-row">
      <span>‚å® <span class="kbd">Space</span> ÂÜçÁîü/ÂÅúÊ≠¢</span>
      <span><span class="kbd">‚Üê/‚Üí</span> Ââç/Ê¨°</span>
    </div>
  </section>
</main>

<!-- ‚îÄ‚îÄ‚îÄ MOBILE BOTTOM PLAYER BAR ‚îÄ‚îÄ‚îÄ -->
<div id="playerBar">
  <div class="player-progress">
    <span id="pbIdx">0</span>/<span id="pbTotal">0</span>
    <div class="player-prog-track">
      <div class="player-prog-fill" id="pbFill" style="width:0%"></div>
    </div>
  </div>
  <div class="player-controls">
    <button class="ctrl-btn" id="mb-stop" title="ÂÅúÊ≠¢">‚èπ</button>
    <button class="ctrl-btn" id="mb-prev" title="Ââç„Å∏">‚èÆ</button>
    <button class="ctrl-btn play-main" id="mb-play" title="ÂÜçÁîü">‚ñ∂</button>
    <button class="ctrl-btn" id="mb-next" title="Ê¨°„Å∏">‚è≠</button>
    <button class="ctrl-btn" id="mb-reveal" title="Á≠î„Åà„ÇíË°®Á§∫" style="font-size:16px;">üëÅ</button>
  </div>
</div>

<script>
'use strict';

const gapQ = { value: 0.5 };
const gapAfterA = { value: 0.5 };
const pitch = { value: 1 };

const SAMPLE_DATA = {
  version: 1,
  items: [
    { q: "Â§™ÈôΩÁ≥ª„ÅßÊúÄ„ÇÇÂ§ß„Åç„ÅÑÊÉëÊòü„ÅØÔºü", a: "Êú®Êòü" },
    { q: "‰∏ÄÁï™Ëøë„ÅÑÊÅíÊòüÔºàÂ§™ÈôΩ„ÇíÈô§„ÅèÔºâ„ÅØÔºü", a: "„Éó„É≠„Ç≠„Ç∑„Éû„Éª„Ç±„É≥„Çø„Ç¶„É™" },
    { q: "ÂÖâ„Åå1Âπ¥Èñì„Å´ÈÄ≤„ÇÄË∑ùÈõ¢„Çí‰Ωï„Å®„ÅÑ„ÅÜÔºü", a: "ÂÖâÂπ¥" },
    { q: "ÈäÄÊ≤≥Á≥ª„ÅÆ‰∏≠ÂøÉ„Å´„ÅÇ„Çã„Å®ËÄÉ„Åà„Çâ„Çå„Å¶„ÅÑ„ÇãÂ§©‰Ωì„ÅØÔºü", a: "Â∑®Â§ß„Éñ„É©„ÉÉ„ÇØ„Éõ„Éº„É´" }
  ],
  settings: { repeatQ: 1, delayA: 3, vol: 0.8, rate: 1, langHint: "ja-JP", showAnswer: false }
};

let items = [];
let idx = -1;
let playing = false;
let paused = false;
let playSessionId = 0;
let currentTimeout = null;
let revealAnswerForCurrent = false;
let revealedAnswerIdxSet = new Set();

const el = {
  clearBtn: document.getElementById('clearBtn'),
  loadSampleBtn: document.getElementById('loadSampleBtn'),
  startBtn: document.getElementById('startBtn'),
  pauseBtn: document.getElementById('pauseBtn'),
  stopBtn: document.getElementById('stopBtn'),
  prevBtn: document.getElementById('prevBtn'),
  nextBtn: document.getElementById('nextBtn'),
  prog: document.getElementById('prog'),
  status: document.getElementById('status'),
  topImportFile: document.getElementById('topImportFile'),
  repeatQ: document.getElementById('repeatQ'),
  delayA: document.getElementById('delayA'),
  vol: document.getElementById('vol'),
  rate: document.getElementById('rate'),
  voiceSel: document.getElementById('voice'),
  langHint: document.getElementById('langHint'),
  showAnswerSel: document.getElementById('showAnswer'),
  list: document.getElementById('list'),
  errorMsg: document.getElementById('errorMsg'),
  successMsg: document.getElementById('successMsg'),
  // Now playing
  nowPlaying: document.getElementById('nowPlaying'),
  npNumber: document.getElementById('npNumber'),
  npQuestion: document.getElementById('npQuestion'),
  npAnswer: document.getElementById('npAnswer'),
  npFill: document.getElementById('npFill'),
  // Mobile bar
  pbIdx: document.getElementById('pbIdx'),
  pbTotal: document.getElementById('pbTotal'),
  pbFill: document.getElementById('pbFill'),
  mbPlay: document.getElementById('mb-play'),
  mbStop: document.getElementById('mb-stop'),
  mbPrev: document.getElementById('mb-prev'),
  mbNext: document.getElementById('mb-next'),
  mbReveal: document.getElementById('mb-reveal'),
};

function updateStatus(msg) { el.status.textContent = msg; }

function updateProgress() {
  const val = (idx >= 0 && items.length) ? (idx + 1) / items.length : 0;
  el.prog.value = val;
  el.pbFill.style.width = (val * 100) + '%';
  el.npFill.style.width = (val * 100) + '%';
  el.pbIdx.textContent = idx >= 0 ? idx + 1 : 0;
  el.pbTotal.textContent = items.length;
  el.npNumber.textContent = items.length ? `${idx + 1} / ${items.length}` : '‚Äî / ‚Äî';
}

function showError(m) { el.errorMsg.textContent = m; el.errorMsg.style.display='block'; setTimeout(()=>el.errorMsg.style.display='none', 5000); }
function showSuccess(m) { el.successMsg.textContent = m; el.successMsg.style.display='block'; setTimeout(()=>el.successMsg.style.display='none', 3000); }

function updateNowPlaying() {
  if (!items.length || idx < 0) {
    el.nowPlaying.classList.remove('visible');
    return;
  }
  el.nowPlaying.classList.add('visible');
  const it = items[idx];
  el.npQuestion.textContent = it ? it.q : '';
  const alwaysShow = el.showAnswerSel.value === '1';
  const showAns = alwaysShow || revealedAnswerIdxSet.has(idx) || (playing && idx >= 0 && revealAnswerForCurrent);
  if (showAns && it) {
    el.npAnswer.textContent = '‚ñ∏ ' + it.a;
    el.npAnswer.classList.remove('hidden');
  } else {
    el.npAnswer.textContent = '‚ñ∏ ?';
    el.npAnswer.classList.add('hidden');
  }
}

function updateMobilePlayBtn() {
  if (playing && !paused) {
    el.mbPlay.textContent = '‚è∏';
    el.mbPlay.title = '‰∏ÄÊôÇÂÅúÊ≠¢';
  } else {
    el.mbPlay.textContent = '‚ñ∂';
    el.mbPlay.title = 'ÂÜçÁîü';
  }
}

function loadVoices() {
  const voices = speechSynthesis.getVoices();
  const hint = el.langHint.value;
  el.voiceSel.innerHTML = '';
  const filtered = voices.filter(v => v.lang.startsWith(hint.substring(0, 2)));
  (filtered.length ? filtered : voices).forEach(v => {
    const opt = document.createElement('option');
    opt.value = v.name; opt.textContent = `${v.name} (${v.lang})`;
    el.voiceSel.appendChild(opt);
  });
}

speechSynthesis.addEventListener('voiceschanged', loadVoices);
el.langHint.addEventListener('change', loadVoices);

function hardStop() {
  playSessionId++;
  speechSynthesis.cancel();
  if (currentTimeout) { clearTimeout(currentTimeout); currentTimeout = null; }
  revealAnswerForCurrent = false;
}

async function speakText(text, sessionAtStart) {
  return new Promise(resolve => {
    if (sessionAtStart !== playSessionId || !playing) return resolve();
    const u = new SpeechSynthesisUtterance(String(text || ''));
    const voices = speechSynthesis.getVoices();
    u.voice = voices.find(v => v.name === el.voiceSel.value) || null;
    u.volume = parseFloat(el.vol.value);
    u.rate = parseFloat(el.rate.value);
    u.lang = el.langHint.value;
    u.onend = resolve;
    u.onerror = resolve;
    speechSynthesis.speak(u);
  });
}

function sleep(ms) {
  return new Promise(resolve => { currentTimeout = setTimeout(() => { currentTimeout = null; resolve(); }, ms); });
}

function renderList() {
  el.list.innerHTML = '';
  const alwaysShow = el.showAnswerSel.value === '1';
  items.forEach((it, i) => {
    const row = document.createElement('div');
    row.className = `item ${i === idx ? 'active' : ''}`;
    row.dataset.idx = i;

    const num = document.createElement('div');
    num.className = 'item-num';
    num.textContent = `#${i+1}`;
    row.appendChild(num);

    const content = document.createElement('div');
    content.style.flex = '1';
    const qDiv = document.createElement('div'); qDiv.className = 'q'; qDiv.textContent = it.q;
    content.appendChild(qDiv);

    if (alwaysShow || revealedAnswerIdxSet.has(i) || (playing && i === idx && revealAnswerForCurrent)) {
      const aDiv = document.createElement('div'); aDiv.className = 'a'; aDiv.textContent = `‚ñ∏ ${it.a}`;
      content.appendChild(aDiv);
    }
    row.appendChild(content);
    el.list.appendChild(row);
  });
  updateNowPlaying();
  updateProgress();
}

async function playLoop(sessionAtStart) {
  while (sessionAtStart === playSessionId && playing) {
    if (idx < 0 || idx >= items.length) {
      playing = false; updateStatus('Discovery Complete'); updateMobilePlayBtn(); renderList(); return;
    }
    const it = items[idx];
    revealAnswerForCurrent = false;
    renderList();
    updateProgress();
    el.list.children[idx]?.scrollIntoView({behavior:'smooth', block:'center'});
    updateStatus(`Exploring #${idx + 1}...`);
    updateMobilePlayBtn();

    for (let r = 0; r < parseInt(el.repeatQ.value); r++) {
      if (sessionAtStart !== playSessionId) return;
      await speakText(it.q, sessionAtStart);
      await sleep(500);
    }

    await sleep(parseFloat(el.delayA.value) * 1000);
    if (sessionAtStart !== playSessionId) return;

    revealAnswerForCurrent = true;
    revealedAnswerIdxSet.add(idx);
    renderList();
    updateNowPlaying();

    await speakText(it.a, sessionAtStart);
    await sleep(500);

    idx++;
    if (idx >= items.length) { playing = false; updateStatus('Voyage End'); updateMobilePlayBtn(); renderList(); return; }
  }
}

// ‚îÄ‚îÄ‚îÄ Button handlers ‚îÄ‚îÄ‚îÄ
function doStart() {
  if(!items.length) return;
  hardStop(); idx=0; playing=true; paused=false;
  updateMobilePlayBtn(); startNoteLoop(); playLoop(playSessionId);
}

function doPause() {
  if (paused) {
    hardStop(); playing=true; paused=false;
    startNoteLoop(); playLoop(playSessionId);
  } else if (playing) {
    hardStop(); playing=false; paused=true;
    startNoteLoop(); updateStatus('Paused');
    renderList();
  }
  updateMobilePlayBtn();
}

function doStop() {
  hardStop(); playing=false; paused=false; idx=-1;
  renderList(); updateProgress(); updateStatus('Stopped');
  startNoteLoop(); updateMobilePlayBtn();
  el.nowPlaying.classList.remove('visible');
}

function doNext() {
  if(!items.length) return;
  hardStop(); idx=Math.min(items.length-1, Math.max(0,idx)+1);
  playing=true; paused=false;
  startNoteLoop(); updateMobilePlayBtn(); playLoop(playSessionId);
}

function doPrev() {
  if(!items.length) return;
  hardStop(); idx=Math.max(0, idx-1);
  playing=true; paused=false;
  startNoteLoop(); updateMobilePlayBtn(); playLoop(playSessionId);
}

// Desktop buttons
el.startBtn.onclick = doStart;
el.pauseBtn.onclick = doPause;
el.stopBtn.onclick = doStop;
el.nextBtn.onclick = doNext;
el.prevBtn.onclick = doPrev;

// Mobile bar buttons
el.mbPlay.onclick = () => {
  if (!playing && !paused) doStart();
  else doPause();
};
el.mbStop.onclick = doStop;
el.mbNext.onclick = doNext;
el.mbPrev.onclick = doPrev;
el.mbReveal.onclick = () => {
  if (idx < 0 || !items.length) return;
  revealAnswerForCurrent = true;
  revealedAnswerIdxSet.add(idx);
  renderList();
};

// List click
el.list.onclick = (e) => {
  const row = e.target.closest('.item');
  if(!row) return;
  hardStop(); idx = parseInt(row.dataset.idx); playing=true; paused=false;
  startNoteLoop(); updateMobilePlayBtn(); playLoop(playSessionId);
};

// Load handlers
el.loadSampleBtn.onclick = () => { loadDataFromJSON(SAMPLE_DATA); showSuccess('„Çµ„É≥„Éó„É´„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü'); };

el.clearBtn.onclick = () => {
  hardStop(); items=[]; idx=-1; revealedAnswerIdxSet=new Set();
  renderList(); updateProgress(); updateStatus('Ready...');
  el.nowPlaying.classList.remove('visible');
  updateMobilePlayBtn();
};

document.getElementById('loadDirectBtn').onclick = () => {
  const raw = document.getElementById('directInput').value.trim();
  if (!raw) { showError('„ÉÜ„Ç≠„Çπ„Éà„ÅåÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì'); return; }
  const lines = raw.split('\n').map(l => l.trim()).filter(Boolean);
  const parsed = [];
  for (const line of lines) {
    const sep = line.includes('\t') ? '\t' : '|';
    const parts = line.split(sep);
    if (parts.length >= 2) {
      const q = parts[0].trim();
      const a = parts.slice(1).join(sep).trim();
      if (q && a) parsed.push({ q, a });
    }
  }
  if (!parsed.length) { showError('ÊúâÂäπ„Å™Q&A„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ„ÄåË≥™Âïè|Á≠î„Åà„ÄçÂΩ¢Âºè„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'); return; }
  loadDataFromJSON({ version: 1, items: parsed });
  showSuccess(`${parsed.length}Âïè Ë™≠„ÅøËæº„Åø„Åæ„Åó„ÅüÔºÅ`);
};

el.topImportFile.onchange = (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => { loadDataFromJSON(JSON.parse(reader.result)); showSuccess('JSON Loaded'); };
  reader.readAsText(file);
};

function loadDataFromJSON(data) {
  hardStop();
  items = data.items || [];
  revealedAnswerIdxSet = new Set();
  idx = items.length ? 0 : -1;
  renderList(); updateProgress(); loadVoices(); startNoteLoop();
  updateMobilePlayBtn();
  if (items.length) el.nowPlaying.classList.add('visible');
}

// Settings accordion
document.getElementById('settingsToggle').onclick = function() {
  this.classList.toggle('open');
  document.getElementById('settingsBody').classList.toggle('open');
};

// Keyboard shortcuts
window.addEventListener('keydown', (e) => {
  if (['INPUT','SELECT','TEXTAREA'].includes(document.activeElement.tagName)) return;
  if (e.code === 'Space') { e.preventDefault(); doPause(); }
  if (e.key === 'ArrowRight') doNext();
  if (e.key === 'ArrowLeft') doPrev();
});

/* ‚îÄ‚îÄ‚îÄ Floating Notes Background ‚îÄ‚îÄ‚îÄ */
const bgNotesEl = document.getElementById('bg-notes');
const noteSymbols = ['‚ô™','‚ô´','‚ô¨','‚ô©'];

function createFloatingNote() {
  const note = document.createElement('div');
  note.className = 'floating-note';
  note.textContent = noteSymbols[(Math.random() * noteSymbols.length) | 0];
  const x = Math.random() * window.innerWidth;
  note.style.left = `${x}px`;
  const duration = 5 + Math.random() * 5;
  const size = 12 + Math.random() * 18;
  const drift = (Math.random() * 120 - 60).toFixed(0) + 'px';
  note.style.fontSize = `${size}px`;
  note.style.animationDuration = `${duration}s`;
  note.style.opacity = (0.25 + Math.random() * 0.55).toFixed(2);
  note.style.setProperty('--drift', drift);
  bgNotesEl.appendChild(note);
  setTimeout(() => note.remove(), duration * 1000);
}

let noteTimer = null;
function startNoteLoop() {
  if (noteTimer) clearInterval(noteTimer);
  const interval = playing ? 700 : 520;
  noteTimer = setInterval(createFloatingNote, interval);
}

startNoteLoop();
loadVoices();
</script>
</body>
</html>
